{% extends "base.html" %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}

<!-- ===== Header ===== -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-semibold">üéì Student Dashboard</h3>
</div>

<!-- ===== Student Info Card ===== -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="mb-3">Student Information</h5>
        <div class="row">
            <div class="col-md-6 mb-2"><strong>Name:</strong> {{ student.user.get_full_name|default:student.user.username }}</div>
            <div class="col-md-6 mb-2"><strong>Roll:</strong> {{ student.roll_number }}</div>
            <div class="col-md-6 mb-2"><strong>Department:</strong> {{ student.department.name }}</div>
            <div class="col-md-6 mb-2"><strong>Class:</strong> {{ student.class_section.name }}</div>
            <div class="col-md-6 mb-2"><strong>Batch:</strong> {{ student.batch.name }}</div>
        </div>
    </div>
</div>

<!-- ===== Invitations ===== -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="mb-3">ü§ù Invitations</h5>

        <form method="post" action="{% url 'send_invite' %}" class="row g-2 mb-3">
            {% csrf_token %}
            <div class="col-md-6">
                <input type="text"
                       name="roll_number"
                       class="form-control"
                       placeholder="Enter friend‚Äôs roll number"
                       required>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    Send Invite
                </button>
            </div>
        </form>

        <!-- Received -->
        <h6 class="mt-3">Received Invitations</h6>
        {% if invitations %}
        <div class="table-responsive">
            <table class="table table-hover table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>From</th>
                        <th>Team</th>
                        <th>Message</th>
                        <th>Sent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                {% for inv in invitations %}
                    <tr>
                        <td>{{ inv.from_student.user.get_full_name|default:inv.from_student.user.username }}</td>
                        <td>{{ inv.team_name }}</td>
                        <td>{{ inv.message|default:"-" }}</td>
                        <td>{{ inv.created_at|date:"d M Y H:i" }}</td>
                        <td>
                            {% if inv.status == "PENDING" %}
                                <a href="{% url 'respond_invite' inv.id 'accept' %}"
                                   class="btn btn-sm btn-success me-1">Accept</a>
                                <a href="{% url 'respond_invite' inv.id 'reject' %}"
                                   class="btn btn-sm btn-outline-danger">Reject</a>
                            {% else %}
                                <span class="badge bg-secondary">{{ inv.get_status_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="text-muted">No received invitations.</p>
        {% endif %}

        <!-- Sent -->
        <h6 class="mt-4">Sent Invitations</h6>
        {% if sent_invitations %}
        <div class="table-responsive">
            <table class="table table-hover table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>To</th>
                        <th>Team</th>
                        <th>Message</th>
                        <th>Sent</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for inv in sent_invitations %}
                    <tr>
                        <td>{{ inv.to_student.user.get_full_name|default:inv.to_student.user.username }}</td>
                        <td>{{ inv.team_name }}</td>
                        <td>{{ inv.message|default:"-" }}</td>
                        <td>{{ inv.created_at|date:"d M Y H:i" }}</td>
                        <td>
                            <span class="badge bg-info">{{ inv.get_status_display }}</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="text-muted">No sent invitations.</p>
        {% endif %}
    </div>
</div>

<!-- ===== Team Section ===== -->
{% if team %}
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h4 class="mb-3">üë• My Team</h4>

        <p><strong>Name:</strong> {{ team.name }}</p>
        <p><strong>Team ID:</strong> {{ team.team_id_code|default:"Not assigned" }}</p>

        <p>
            <strong>Members:</strong><br>
            {% for member in team.members.all %}
                ‚Ä¢ {{ member.user.get_full_name|default:member.user.username }}
                {% if member.id == student.id %}(You){% endif %}
                {% if team.team_leader_id == member.id %} <span class="badge bg-warning text-dark">TL</span>{% endif %}
                <br>
            {% endfor %}
        </p>

        <p>
            <strong>Status:</strong>
            {% if team.proposal and team.proposal.status == "APPROVED" %}
                <span class="badge bg-success">Approved</span>
            {% elif team.proposal %}
                <span class="badge bg-warning text-dark">{{ team.proposal.get_status_display }}</span>
            {% else %}
                <span class="badge bg-secondary">Proposal not created</span>
            {% endif %}
        </p>
    </div>
</div>

<!-- ===== Proposal ===== -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5>üìÑ Project Proposal</h5>

        {% if team.proposal %}
            <p><strong>Title:</strong> {{ team.proposal.title|default:"Not set" }}</p>
            <p><strong>Coordinator Comment:</strong><br>
                <span class="text-muted">{{ team.proposal.coordinator_comment|default:"None" }}</span>
            </p>

            <p><strong>Documents:</strong></p>
            <ul>
                {% for doc in team.proposal.documents.all %}
                    <li>
                        <a href="{{ doc.file.url }}" target="_blank">
                            Version {{ doc.version }} ‚Äì {{ doc.uploaded_at|date:"d M Y H:i" }}
                        </a>
                    </li>
                {% empty %}
                    <li class="text-muted">No documents uploaded</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">Proposal not created yet.</p>
        {% endif %}
    </div>
</div>

<!-- ===== Reviews ===== -->
<div class="card shadow-sm">
    <div class="card-body">
        <h5>üóì Review Schedule</h5>
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Review</th>
                        <th>Date</th>
                        <th>Requirements</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>0th Review</td>
                        <td>{{ team.proposal.updated_at|date:"d M Y"|default:"-" }}</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>1st Review</td>
                        <td>{{ first_review.date|date:"d M Y"|default:"-" }}</td>
                        <td>{{ first_review.requirements|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td>2nd Review</td>
                        <td>{{ second_review.date|date:"d M Y"|default:"-" }}</td>
                        <td>{{ second_review.requirements|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td>Final Review</td>
                        <td>{{ final_review.date|date:"d M Y"|default:"-" }}</td>
                        <td>{{ final_review.requirements|default:"-" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info">
    You are not part of a team yet.
</div>
{% endif %}

{% endblock %}
